<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>-</title>
    <script src="https://cdn.ethers.io/lib/ethers-5.2.umd.min.js" type="application/javascript"></script>
    <script src='https://cdn.bootcdn.net/ajax/libs/bignumber.js/9.0.1/bignumber.min.js'></script>
</head>

<body>
    <div id="myHeading">测试2</div>
    <script>
        var h1Element = document.getElementById('myHeading');
        function showLog(str) {
            h1Element.textContent += '<br>||' + str;
        }
        let is_Native = !!(+new URLSearchParams(window.location.search)?.get('isNative'));

    </script>
    <script>
        // 接受相关
        function strToFun(data) {
            if (!data) return;
            console.log("WebView接收:", data.fun);
            showLog('strToFun---->' + data.fun);
            window[data.fun] && window[data.fun](data.parm);
        }
        //web接收来自cocos的消息
        window.addEventListener('message', function (e) {
            let data = e.data;
            if (!data.startsWith("_ToWeb")) return;
            data = data.replace("_ToWeb", "");
            try {
                data = data && JSON.parse(data); //参数
            } catch (error) {
                showLog('webMess_error---->' + error.toString());
            }
            strToFun(data);
        });
        // 安卓时接受cocos数据
        function cocosToWeb(params) {
            strToFun(params);
        }
        // web发送消息给cocos
        function sendToCocos(data) {
            showLog('sendToCocos---->' + data.fName);
            if (is_Native || is_Native === undefined) { //android or ios
                document.location = 'testkey://' + encodeURIComponent(JSON.stringify(data));
            }
            if (!is_Native) { //browser 浏览器下，向cocos发送消息
                parent.postMessage("_ToCocos" + JSON.stringify(data), "*");
            }
        }
    </script>
    <script>
        // 初始化完成 通知cocos
        sendToCocos({ fName: "webReady", result: null, });
        // 执行cocos传过来的代码
        function evalJS(params) {
            showLog('=========evalJS=========');
            try {
                new Function(params.jsStr)();
                sendToCocos({ fName: params.fName, result: null });
            } catch (error) {
                showLog('evalJS_error---->' + error.toString());
            }
        }
        // 调钱包方法
        function toNWalletFun(params) {
            showLog('=========toNWalletFun=========');
            if (!NWallet) return;
            try {
                NWallet[params.fun1](params)?.then((result) => {
                    sendToCocos({ fName: params.fName, result });
                });
            } catch (error) {
                showLog('toNWalletFun_error---->' + error.toString());
            }
        }
    </script>
</body>

</html>
